
var options = {

    videos  : [      
        {
            videoUrl : "videos/0/0.mp4",
            title : "a lingua do tempo 1",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/1/1.mp4",
            title : "a lingua do tempo 2",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },        
        {
            videoUrl : "videos/2/2.mp4",
            title : "variações do falar 1",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },  
        {
            videoUrl : "videos/3/3.mp4",
            title : "variações do falar 2",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },        
        {
            videoUrl : "videos/4/4.mp4",
            title : "certo ou errado 1",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },        
        {
            videoUrl : "videos/5/5.mp4",
            title : "certo ou errado 2",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/6/6.mp4",
            title : "língua e opressão 1",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/7/7.mp4",
            title : "língua e opressão 2",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/8/8.mp4",
            title : "língua e opressão 3",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/9/9.mp4",
            title : "palavrões e dialetos 1",
            swearWords : true,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/10/10.mp4",
            title : "palavrões e dialetos 2",
            swearWords : true,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/11/11.mp4",
            title : "palavrões e dialetos 3",
            swearWords : true,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/12/12.mp4",
            title : "acordos ortográficos",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/13/13.mp4",
            title : "libras e português 1",
            swearWords : false,
            subtitles : [
                { 
                    type : "libras",
                    url : 'libras.webm' ,
                    title : "Libras",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt',
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt',
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
        {
            videoUrl : "videos/14/14.mp4",
            title : "libras e português 2",
            swearWords : false,
            subtitles : [
                // { 
                //     type : "libras",
                //     url : 'libras.webm' ,
                //     title : "Libras",
                //     default : false
                // },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/es.vtt' ,
                    title : "Ingles",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/de.vtt' ,
                    title : "Espanhol",
                    default : false
                },
                { 
                    type : "text",
                    url : 'videos/' + index + '/subs/en.vtt' ,
                    title : 'Portugês',
                    default : true
                }
            ]
        },
    ]

}


function falares(_data){

    this.data = _data
    this.videos = []
    this.videosContaners = []
    this.indicators = []
    this.overlays = []
    this.selectedVideoId = 0;
    this.moved = false
    this.menuOpened = true
    this.videosLoaded = 0

    this.createDOMElements()
}

//===============================================================
//===============================================================

falares.prototype.createDOMElements = function(){

    this.videoContainer = document.createElement('div')
    this.videoContainer.className = "videosContainer"
    document.body.appendChild(this.videoContainer)

    //---------------
    // preview menu
    //---------------
    this.menuContainer = document.createElement('div')
    this.menuContainer.className = "menuContainer"
    document.body.appendChild(this.menuContainer)

    this.previewList = document.createElement('div')
    this.previewList.className = "previewList"
    this.menuContainer.appendChild(this.previewList)

    this.colapseContainer = document.createElement('div')
    this.colapseContainer.className = "colapseContainer open"
    document.body.appendChild(this.colapseContainer)
    this.colapseContainer.addEventListener("touchend", _event =>{
        this.toggleMenu()
    })

    var left = document.createElement('div')
    left.className = "left"
    this.colapseContainer.appendChild(left)

    var right = document.createElement('div')
    right.className = "right"
    this.colapseContainer.appendChild(right)


    for (let i = 0; i < this.data.videos.length; i++) {
        

        //Create Videos
        var videosContaner = document.createElement('div')
        videosContaner.className = "video-" + i 
        this.videoContainer.appendChild(videosContaner)
        this.videosContaners.push(videosContaner)
        
        //-----------------------------------------
        // overlays 
        //-----------------------------------------
        
        var overlay = document.createElement('div')
        overlay.style.display = "none"
        overlay.style.zIndex = "1"
        overlay.className = "overlay"
        overlay.addEventListener('webkitTransitionEnd', (e) => {    
            this.toggleOverlayVisibility(e.target)
        })
        this.overlays.push(overlay)
        videosContaner.appendChild(overlay)

        var overlayContent = document.createElement('div')
        overlayContent.className = "overlayContent"
        overlay.appendChild(overlayContent)

        var backGround = document.createElement('div')
        backGround.className = "overlayBG"
        overlay.appendChild(backGround)
        
        if(this.data.videos[i].swearWords){

            var warningContainer = document.createElement('div')
            warningContainer.className = "warningContainer"
            overlayContent.appendChild(warningContainer)

            var warningImg = new Image()
            warningImg.className = "warningImg"
            warningImg.src = "warning.png"
            warningContainer.appendChild(warningImg)

            var warning = document.createElement('div')
            warning.className = "warning"
            warning.innerHTML = "Conteúdo com linguagem potencialmente ofensiva"
            warningContainer.appendChild(warning)
            
        }

        var title = document.createElement('div')
        title.className = "overlayTitle"
        title.innerHTML = this.data.videos[i].title
        overlayContent.appendChild(title)

        var line = document.createElement('div')
        line.className = "overlayLine"
        overlayContent.appendChild(line)

        var overlayIconContainer =  document.createElement('div')
        overlayIconContainer.className = "overlayIconContainer"
        overlayContent.appendChild(overlayIconContainer)

        var icon = document.createElement('div')
        icon.className = "overlayIcon"
        overlayIconContainer.appendChild(icon)
        icon.addEventListener("touchend", _event =>{
            this.toggleMenu()
        })

        var fullScreen = document.createElement('div')
        fullScreen.className = "overlayfullScreen"
        fullScreen.innerHTML = "Tela cheia"
        overlayIconContainer.appendChild(fullScreen)

        var left = document.createElement('div')
        left.className = "left"
        icon.appendChild(left)
    
        var right = document.createElement('div')
        right.className = "right"
        icon.appendChild(right)

        //-----------------------------------------
        // previews
        //-----------------------------------------

        var scrollPadding = 50
        var container = document.createElement('div')
        container.className = "previewComtanier"
        container.id = i
        if(i == 0 ) container.style.marginTop = scrollPadding + "px"
        if(i == this.data.videos.length -1 ) container.style.marginBottom = scrollPadding + "px"
        this.previewList.appendChild(container)
        container.addEventListener("touchend", _event =>{    
            if(i != this.selectedVideoId){
                this.changeVideo(i);
            }
            this.moved = false            
        })
        container.addEventListener("touchmove", ()=>{
            this.moved = true
        })

        var indicator = document.createElement('div')
        indicator.className = "indicatorBg"
        this.indicators.push(indicator)
        container.appendChild(indicator)

        var indicatorOff = document.createElement('div')
        indicatorOff.className = "indicator"
        indicator.appendChild(indicatorOff)

        //preview Title
        var previewTitle = document.createElement('div')
        previewTitle.className = "previewTitle"
        previewTitle.innerHTML = "<br>" + this.data.videos[i].title
        container.appendChild(previewTitle)

        if(this.data.videos[i].swearWords){
            previewTitle.className = "previewSwearWords previewTitle"
        }

        this.createVideos(i,videosContaner,container)
             
    }
    this.loadingOverlay = document.createElement('div')
    this.loadingOverlay.className = "loadingOverlay"
    this.loadingOverlay.innerHTML = '<div class="loader"></div>'

    document.body.appendChild(this.loadingOverlay)

}

falares.prototype.createVideos = function(_i, _videosContaner, _imageContainer){
        
    var player = new simplePlayer(
        this.data.videos[_i].videoUrl,
        this.data.videos[_i].subtitles,
        this.data.videos[_i].title,    
        _videosContaner
    );
    
    player.videoEnded = ()=> { this.videoEnded(_i) } 
    player.id = _i
    player.swearWords = this.data.videos[_i].swearWords
    this.videos.push(player)
        
    player.onloaded = (_e) => { 

        this.getVideoImage(player,_imageContainer,1,_e.target.currentSrc)
        
    }
    
}

falares.prototype.removeLoadingOverlay = function(_player,_imageContainer,scale){

    this.loadingOverlay.style.display = "none"

}

falares.prototype.getVideoImage = function(_player,_imageContainer,scale,_url){

    scale = scale || 1;

    const canvas = document.createElement("canvas");
    canvas.width = _player.video.clientWidth * scale;
    canvas.height = _player.video.clientHeight * scale;
    var context = canvas.getContext('2d')
    
    var getPixels = (__player) => {

        
        _player.video.currentTime = 30
        context.drawImage(_player.video, 0, 0, canvas.width, canvas.height);
        var pixels = context.getImageData(0,0,100,100).data

        if(pixels[0]==0 && pixels[0]==0 && !_player.imageLoaded){
            setTimeout(() => { getPixels()} , 1000)
        }else{

            _player.imageLoaded = true

            if(!_player.coverImage){
                const image = new Image()
                image.src = canvas.toDataURL()
                image.className = "imagePreview"
                image.id = _player.id
                _imageContainer.appendChild(image)
                _player.coverImage = image
    
                if(_player.id != 0 ) _player.toggleVisibility()
                _player.onloaded = () =>{}

                this.videosLoaded++
                if(this.videosLoaded == this.videos.length){
                    this.removeLoadingOverlay()
                    this.changeVideo(0)
                }
                // _player.removeVideoElement()
                
            }

            _player.video.currentTime = 0
            _player.controls.setCurrentTime(0)


        }

    }

    getPixels(_player)

}

falares.prototype.videoEnded = function(_id){

    var increment = 1

    while(this.videos[(_id + increment)%this.videos.length].swearWords == true){
        increment++
        console.log(increment);
        
    }

    this.changeVideo((_id + increment)%this.videos.length)
    this.openMenu()
    this.videos[this.selectedVideoId].controls.play()

}

//===============================================================
//===============================================================


falares.prototype.toggleMenu = function(){

    if(this.menuOpened){  this.closeMenu() }
    else{  this.openMenu() }
    this.menuOpened = !this.menuOpened

}

falares.prototype.openMenu = function(){

    this.videos[this.selectedVideoId].controls.closeControls()
    this.menuContainer.classList.remove("displayNone") 
    this.colapseContainer.classList.add("open")
    this.overlays[this.selectedVideoId].classList.remove("displayNone")    
    setTimeout(() => { 
        
        this.previewList.classList.remove("off")
        this.videoContainer.style.zIndex = 1
        this.overlays[this.selectedVideoId].classList.remove("off") 

    },1)


}

falares.prototype.closeMenu = function(){

    setTimeout(() => { 
        this.colapseContainer.classList.remove("open")
        this.previewList.classList.add("off")  
        this.videoContainer.style.zIndex = 1
        this.overlays[this.selectedVideoId].classList.add("off")
    },1)

}

falares.prototype.toggleOverlayVisibility = function(_element){    

    if(!this.menuOpened){
       _element.classList.toggle("displayNone")  
       this.menuContainer.classList.toggle("displayNone")  
    }

}

falares.prototype.enterFullScreen = function(){
    this.closeMenu()
}

falares.prototype.exitFullScreen = function(){
    this.openMenu()
}

falares.prototype.changeVideo = function(_index){
    //do nothing if mouse is moving
    if(this.moved) return

    //pause previous video and close its controls
    this.videos[this.selectedVideoId].controls.pause()
    this.videos[this.selectedVideoId].controls.closeControls()
    
    //change indicator style to match selected video
    for (let i = 0; i < this.indicators.length; i++) {
        if( i != _index ){
            this.indicators[i].children[0].className = "indicator";
        }
    }

    if (_index > this.selectedVideoId){
        this.indicators[this.selectedVideoId].children[0].classList.add("bottom")
        this.indicators[_index].children[0].classList.remove("bottom")
    }else{
        this.indicators[this.selectedVideoId].children[0].classList.remove("bottom")
        this.indicators[_index].children[0].classList.add("bottom")
    }
    this.indicators[_index].children[0].classList.add("on")    
    
    //hide deselected video
    this.videos[this.selectedVideoId].toggleVisibility()
    this.overlays[this.selectedVideoId].style.display = "none"
    
    //Show selected video
    this.videos[_index].toggleVisibility()
    this.overlays[_index].style.display = "block"
    this.selectedVideoId = _index
    
    this.videos[this.selectedVideoId].controls.play()

}


//===============================================================
//===============================================================


for ( var i = 0; i < 1; i++){
    var v = new falares(options)
}

window.addEventListener("touchstart", (en) =>{
    // console.log(en.target);
})